<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>閲覧履歴</title>

    <!-- GoogleFonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Bree+Serif&family=Dela+Gothic+One&family=DotGothic16&family=Kaisei+Decol&family=Kaisei+Opti&family=Lora:ital,wght@0,400..700;1,400..700&family=Moirai+One&family=Permanent+Marker&family=Playfair+Display:ital,wght@0,400..900;1,400..900&family=Zen+Kaku+Gothic+New:wght@300;400;500;700;900&family=Zen+Kurenaido&family=Zen+Maru+Gothic:wght@300;400;500;700;900&display=swap"
      rel="stylesheet"
    />

    <!-- reset -->
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/the-new-css-reset/css/reset.min.css"
    />

    <link rel="stylesheet" href="./css/houses.css" />
    <link rel="stylesheet" href="./css/museums.css" />
    <link rel="stylesheet" href="./css/history.css" />

    <script type="module">
      import { db, collection, doc, getDoc, getDocs } from "./js/firebase.js";

      // ------------------------
      // 博物館データ取得関数
      // ------------------------
      async function fetchMuseumWithRooms(museumId) {
        const museumRef = doc(db, "museums", museumId);
        const museumSnap = await getDoc(museumRef);
        if (!museumSnap.exists()) return null;
        const museum = { id: museumSnap.id, ...museumSnap.data() };
        const roomsSnap = await getDocs(
          collection(db, "museums", museumId, "rooms")
        );
        museum.rooms = roomsSnap.docs.map((r) => ({ id: r.id, ...r.data() }));
        return museum;
      }

      // ------------------------
      // 博物館履歴レンダリング
      // ------------------------
      async function renderMuseumHistory() {
        const container = document.getElementById("museum-list");
        container.innerHTML = "<p>読み込み中...</p>";
        const history = JSON.parse(localStorage.getItem("viewedMuseums")) || [];
        if (!history.length) {
          container.innerHTML = "<p>閲覧履歴はありません。</p>";
          return;
        }
        container.innerHTML = "";

        for (const item of history.sort((a, b) => b.viewedAt - a.viewedAt)) {
          const m = await fetchMuseumWithRooms(item.id);
          if (!m) continue;

          const addrText = m.address
            ? `${m.address.prefecture || ""} ${m.address.city || ""} ${
                m.address.detail || ""
              }`.trim()
            : "不明";

          const div = document.createElement("div");
          div.className = "museum";

          div.innerHTML = `
            <a href="museum.html?museumId=${m.id}&from=history">
              <div class="museum-header">
                <img src="${
                  m.mainPhotoUrl || "./image/item/noimage.png"
                }" alt="${
            m.title || "名称未設定の博物館"
          }" class="museum-photo">
                <h2 class="museum-title">${m.title || "名称未設定の博物館"}</h2>
              </div>
            </a>
            <p class="museums__place"><strong>住所</strong> ${addrText}</p>
            <p class="museums__price"><strong>料金</strong> ${
              m.priceYen ?? "未設定"
            }円</p>
            <h3 class="museums__room">部屋の展示</h3>
            <ul>
              ${(Array.isArray(m.rooms) ? m.rooms : [])
                .map(
                  (r) => `
                  <li class="room">
                    <div class="room__header">
                      <img src="${
                        r.photo || "./image/item/noimage.png"
                      }" alt="${r.title || "展示名なし"}" class="room-photo">
                      <div class="room-info">
                        <strong>${r.title || "展示名なし"}</strong>（${
                    r.floor || "-"
                  }階）
                      </div>
                    </div>
                    ${r.description || "説明なし"}<br>
                    カテゴリ: ${
                      Array.isArray(r.category)
                        ? r.category.join(", ")
                        : r.category ?? "未設定"
                    }
                  </li>`
                )
                .join("")}
            </ul>
          `;
          container.appendChild(div);
        }
      }

      // ------------------------
      // 空き家データ取得関数
      // ------------------------
      async function fetchHouseWithRooms(houseId) {
        const houseRef = doc(db, "houses", houseId);
        const houseSnap = await getDoc(houseRef);
        if (!houseSnap.exists()) return null;
        const house = { id: houseSnap.id, ...houseSnap.data() };
        const roomsSnap = await getDocs(
          collection(db, "houses", houseId, "rooms")
        );
        house.rooms = roomsSnap.docs.map((r) => ({ id: r.id, ...r.data() }));
        return house;
      }

      // ------------------------
      // 空き家履歴レンダリング
      // ------------------------
      async function renderHouseHistory() {
        const container = document.getElementById("house-list");
        container.innerHTML = "<p>読み込み中...</p>";
        const history = JSON.parse(localStorage.getItem("houseHistory")) || [];
        if (!history.length) {
          container.innerHTML = "<p>閲覧履歴はありません。</p>";
          return;
        }
        container.innerHTML = "";

        for (const item of history.sort((a, b) => b.timestamp - a.timestamp)) {
          const h = await fetchHouseWithRooms(item.id);
          if (!h) continue;

          const addrText = h.address
            ? `${h.address.prefecture || ""} ${h.address.city || ""} ${
                h.address.detail || ""
              }`.trim()
            : "不明";

          const div = document.createElement("div");
          div.className = "house";

          div.innerHTML = `
          <a href="house.html?houseId=${h.id}&from=history">
              <div class="house-header">
                <img src="${h.photoUrl || "./image/item/noimage.png"}" alt="${
            h.title || "名称未設定の空き家"
          }" class="house-photo">
                <h2>${h.title || "名称未設定の空き家"}</h2>
              </div>
            </a>
            <p class="house__place"><strong>住所</strong> ${addrText}</p>

            <ul>
              ${(Array.isArray(h.rooms) ? h.rooms : [])
                .map(
                  (r) => `
                  <li class="room">
                    <h4 class="house__room">${r.name || "部屋名なし"}</h4>
                    <img src="${
                      r.photoUrl || "./image/item/noimage.png"
                    }" alt="${r.name}" class="room-photo">
                    <div class="room__right">
                      <p class="room__price"><strong>料金</strong> ${
                        r.priceYen ? r.priceYen + "円" : "未設定"
                      }</p>
                      <p class="room__area"><strong>面積</strong> ${
                        r.area ? r.area + "㎡" : "未設定"
                      }</p>
                      <p class="room__floor"><strong>階数</strong> ${
                        r.floor || "-"
                      }階</p>
                    </div>
                  </li>`
                )
                .join("")}
            </ul>
          `;
          container.appendChild(div);
        }
      }

      // ------------------------
      // タブ切り替え
      // ------------------------
      function setupTabs() {
        const tabButtons = document.querySelectorAll(".tab-button");
        const tabContents = document.querySelectorAll(".tab-content");

        tabButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            tabButtons.forEach((b) => b.classList.remove("active"));
            btn.classList.add("active");

            const target = btn.dataset.tab;
            tabContents.forEach((content) => {
              content.classList.toggle("active", content.id === target);
            });
          });
        });
      }

      // ------------------------
      // 初期化
      // ------------------------
      window.addEventListener("DOMContentLoaded", () => {
        setupTabs();
        renderMuseumHistory();
        renderHouseHistory();

        // --- カード全体クリック可能にする ---
        document.addEventListener("click", (e) => {
          const museumCard = e.target.closest(".museum");
          if (museumCard) {
            const link = museumCard.querySelector("a");
            if (link && !e.target.closest("a")) {
              window.location.href = link.href;
            }
          }

          const houseCard = e.target.closest(".house");
          if (houseCard) {
            const link = houseCard.querySelector("a");
            if (link && !e.target.closest("a")) {
              window.location.href = link.href;
            }
          }
        });
      });
    </script>
  </head>
  <body>
    <div class="historyTop">
      <a href="./mypage.html" class="historyTop__btn">
        <img src="./image/item/btn_back.png" alt="前のページに戻る" />
      </a>
      <h1 class="historyTop__heading">閲覧履歴</h1>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-tab="museums">博物館</button>
      <button class="tab-button" data-tab="houses">空き家</button>
    </div>

    <div id="museums" class="tab-content active">
      <div id="museum-list"></div>
    </div>

    <div id="houses" class="tab-content">
      <div id="house-list"></div>
    </div>
  </body>
</html>
